import 'package:flutter/material.dart';\nimport '../models/hotel.dart';\nimport '../models/booking.dart';\nimport '../services/booking_service.dart';\n\nclass BookingScreen extends StatefulWidget {\n  const BookingScreen({super.key});\n\n  @override\n  State<BookingScreen> createState() => _BookingScreenState();\n}\n\nclass _BookingScreenState extends State<BookingScreen> {\n  final _formKey = GlobalKey<FormState>();\n  final _nameController = TextEditingController();\n  final _emailController = TextEditingController();\n  final _phoneController = TextEditingController();\n  \n  DateTime? _checkInDate;\n  DateTime? _checkOutDate;\n  int _guests = 1;\n  int _rooms = 1;\n\n  @override\n  void dispose() {\n    _nameController.dispose();\n    _emailController.dispose();\n    _phoneController.dispose();\n    super.dispose();\n  }\n\n  Future<void> _selectCheckInDate(BuildContext context) async {\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: DateTime.now(),\n      firstDate: DateTime.now(),\n      lastDate: DateTime.now().add(const Duration(days: 365)),\n    );\n    if (picked != null) {\n      setState(() {\n        _checkInDate = picked;\n        // Reset check-out date if it's before check-in\n        if (_checkOutDate != null && _checkOutDate!.isBefore(_checkInDate!)) {\n          _checkOutDate = null;\n        }\n      });\n    }\n  }\n\n  Future<void> _selectCheckOutDate(BuildContext context) async {\n    final DateTime? picked = await showDatePicker(\n      context: context,\n      initialDate: _checkInDate?.add(const Duration(days: 1)) ?? DateTime.now().add(const Duration(days: 1)),\n      firstDate: _checkInDate?.add(const Duration(days: 1)) ?? DateTime.now().add(const Duration(days: 1)),\n      lastDate: DateTime.now().add(const Duration(days: 365)),\n    );\n    if (picked != null) {\n      setState(() {\n        _checkOutDate = picked;\n      });\n    }\n  }\n\n  int _calculateNights() {\n    if (_checkInDate == null || _checkOutDate == null) return 0;\n    return _checkOutDate!.difference(_checkInDate!).inDays;\n  }\n\n  double _calculateTotal(Hotel hotel) {\n    return hotel.pricePerNight * _calculateNights() * _rooms;\n  }\n\n  void _submitBooking(Hotel hotel) {\n    if (_formKey.currentState!.validate()) {\n      if (_checkInDate == null || _checkOutDate == null) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Please select check-in and check-out dates')),\n        );\n        return;\n      }\n\n      final booking = Booking(\n        id: DateTime.now().millisecondsSinceEpoch.toString(),\n        hotelId: hotel.id,\n        hotelName: hotel.name,\n        hotelImage: hotel.imageUrl,\n        location: hotel.location,\n        checkInDate: _checkInDate!,\n        checkOutDate: _checkOutDate!,\n        guests: _guests,\n        rooms: _rooms,\n        totalPrice: _calculateTotal(hotel),\n        guestName: _nameController.text,\n        guestEmail: _emailController.text,\n        guestPhone: _phoneController.text,\n        status: BookingStatus.confirmed,\n        bookingDate: DateTime.now(),\n      );\n\n      BookingService.createBooking(booking);\n\n      // Show success dialog\n      showDialog(\n        context: context,\n        barrierDismissible: false,\n        builder: (BuildContext context) {\n          return AlertDialog(\n            title: const Row(\n              children: [\n                Icon(Icons.check_circle, color: Colors.green, size: 32),\n                SizedBox(width: 8),\n                Text('Booking Confirmed!'),\n              ],\n            ),\n            content: Column(\n              mainAxisSize: MainAxisSize.min,\n              crossAxisAlignment: CrossAxisAlignment.start,\n              children: [\n                Text('Your booking at ${hotel.name} has been confirmed.'),\n                const SizedBox(height: 8),\n                Text('Booking ID: ${booking.id}'),\n                const SizedBox(height: 8),\n                Text('Total: \$${_calculateTotal(hotel).toStringAsFixed(2)}'),\n              ],\n            ),\n            actions: [\n              TextButton(\n                onPressed: () {\n                  Navigator.of(context).pop(); // Close dialog\n                  Navigator.of(context).pop(); // Go back to details\n                  Navigator.of(context).pop(); // Go back to home\n                },\n                child: const Text('Back to Home'),\n              ),\n              ElevatedButton(\n                onPressed: () {\n                  Navigator.of(context).pop(); // Close dialog\n                  Navigator.pushReplacementNamed(context, '/my-bookings');\n                },\n                child: const Text('View Bookings'),\n              ),\n            ],\n          );\n        },\n      );\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final hotel = ModalRoute.of(context)!.settings.arguments as Hotel;\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text('Book Hotel'),\n      ),\n      body: SingleChildScrollView(\n        padding: const EdgeInsets.all(16),\n        child: Form(\n          key: _formKey,\n          child: Column(\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              // Hotel Summary Card\n              Card(\n                child: Padding(\n                  padding: const EdgeInsets.all(12),\n                  child: Row(\n                    children: [\n                      ClipRRect(\n                        borderRadius: BorderRadius.circular(8),\n                        child: Image.network(\n                          hotel.imageUrl,\n                          width: 80,\n                          height: 80,\n                          fit: BoxFit.cover,\n                          errorBuilder: (context, error, stackTrace) {\n                            return Container(\n                              width: 80,\n                              height: 80,\n                              color: Colors.grey[300],\n                              child: const Icon(Icons.hotel),\n                            );\n                          },\n                        ),\n                      ),\n                      const SizedBox(width: 12),\n                      Expanded(\n                        child: Column(\n                          crossAxisAlignment: CrossAxisAlignment.start,\n                          children: [\n                            Text(\n                              hotel.name,\n                              style: const TextStyle(\n                                fontWeight: FontWeight.bold,\n                                fontSize: 16,\n                              ),\n                            ),\n                            const SizedBox(height: 4),\n                            Text(\n                              hotel.location,\n                              style: TextStyle(color: Colors.grey[600]),\n                            ),\n                            const SizedBox(height: 4),\n                            Text(\n                              '\$${hotel.pricePerNight.toStringAsFixed(0)} / night',\n                              style: const TextStyle(\n                                color: Colors.blue,\n                                fontWeight: FontWeight.bold,\n                              ),\n                            ),\n                          ],\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              ),\n              const SizedBox(height: 24),\n              // Dates Section\n              Text(\n                'Select Dates',\n                style: Theme.of(context).textTheme.titleLarge?.copyWith(\n                      fontWeight: FontWeight.bold,\n                    ),\n              ),\n              const SizedBox(height: 12),\n              Row(\n                children: [\n                  Expanded(\n                    child: InkWell(\n                      onTap: () => _selectCheckInDate(context),\n                      child: InputDecorator(\n                        decoration: const InputDecoration(\n                          labelText: 'Check-in',\n                          border: OutlineInputBorder(),\n                          prefixIcon: Icon(Icons.calendar_today),\n                        ),\n                        child: Text(\n                          _checkInDate == null\n                              ? 'Select date'\n                              : '${_checkInDate!.day}/${_checkInDate!.month}/${_checkInDate!.year}',\n                        ),\n                      ),\n                    ),\n                  ),\n                  const SizedBox(width: 12),\n                  Expanded(\n                    child: InkWell(\n                      onTap: () => _selectCheckOutDate(context),\n                      child: InputDecorator(\n                        decoration: const InputDecoration(\n                          labelText: 'Check-out',\n                          border: OutlineInputBorder(),\n                          prefixIcon: Icon(Icons.calendar_today),\n                        ),\n                        child: Text(\n                          _checkOutDate == null\n                              ? 'Select date'\n                              : '${_checkOutDate!.day}/${_checkOutDate!.month}/${_checkOutDate!.year}',\n                        ),\n                      ),\n                    ),\n                  ),\n                ],\n              ),\n              if (_calculateNights() > 0) ..[\n                const SizedBox(height: 8),\n                Text(\n                  '${_calculateNights()} night(s)',\n                  style: TextStyle(color: Colors.grey[600]),\n                ),\n              ],\n              const SizedBox(height: 24),\n              // Guests and Rooms\n              Text(\n                'Guests & Rooms',\n                style: Theme.of(context).textTheme.titleLarge?.copyWith(\n                      fontWeight: FontWeight.bold,\n                    ),\n              ),\n              const SizedBox(height: 12),\n              Row(\n                children: [\n                  Expanded(\n                    child: InputDecorator(\n                      decoration: const InputDecoration(\n                        labelText: 'Guests',\n                        border: OutlineInputBorder(),\n                      ),\n                      child: Row(\n                        mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                        children: [\n                          IconButton(\n                            icon: const Icon(Icons.remove_circle_outline),\n                            onPressed: _guests > 1\n                                ? () => setState(() => _guests--)\n                                : null,\n                          ),\n                          Text('$_guests', style: const TextStyle(fontSize: 18)),\n                          IconButton(\n                            icon: const Icon(Icons.add_circle_outline),\n                            onPressed: () => setState(() => _guests++),\n                          ),\n                        ],\n                      ),\n                    ),\n                  ),\n                  const SizedBox(width: 12),\n                  Expanded(\n                    child: InputDecorator(\n                      decoration: const InputDecoration(\n                        labelText: 'Rooms',\n                        border: OutlineInputBorder(),\n                      ),\n                      child: Row(\n                        mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                        children: [\n                          IconButton(\n                            icon: const Icon(Icons.remove_circle_outline),\n                            onPressed: _rooms > 1\n                                ? () => setState(() => _rooms--)\n                                : null,\n                          ),\n                          Text('$_rooms', style: const TextStyle(fontSize: 18)),\n                          IconButton(\n                            icon: const Icon(Icons.add_circle_outline),\n                            onPressed: () => setState(() => _rooms++),\n                          ),\n                        ],\n                      ),\n                    ),\n                  ),\n                ],\n              ),\n              const SizedBox(height: 24),\n              // Guest Information\n              Text(\n                'Guest Information',\n                style: Theme.of(context).textTheme.titleLarge?.copyWith(\n                      fontWeight: FontWeight.bold,\n                    ),\n              ),\n              const SizedBox(height: 12),\n              TextFormField(\n                controller: _nameController,\n                decoration: const InputDecoration(\n                  labelText: 'Full Name',\n                  border: OutlineInputBorder(),\n                  prefixIcon: Icon(Icons.person),\n                ),\n                validator: (value) {\n                  if (value == null || value.isEmpty) {\n                    return 'Please enter your name';\n                  }\n                  return null;\n                },\n              ),\n              const SizedBox(height: 12),\n              TextFormField(\n                controller: _emailController,\n                decoration: const InputDecoration(\n                  labelText: 'Email',\n                  border: OutlineInputBorder(),\n                  prefixIcon: Icon(Icons.email),\n                ),\n                keyboardType: TextInputType.emailAddress,\n                validator: (value) {\n                  if (value == null || value.isEmpty) {\n                    return 'Please enter your email';\n                  }\n                  if (!value.contains('@')) {\n                    return 'Please enter a valid email';\n                  }\n                  return null;\n                },\n              ),\n              const SizedBox(height: 12),\n              TextFormField(\n                controller: _phoneController,\n                decoration: const InputDecoration(\n                  labelText: 'Phone Number',\n                  border: OutlineInputBorder(),\n                  prefixIcon: Icon(Icons.phone),\n                ),\n                keyboardType: TextInputType.phone,\n                validator: (value) {\n                  if (value == null || value.isEmpty) {\n                    return 'Please enter your phone number';\n                  }\n                  return null;\n                },\n              ),\n              const SizedBox(height: 24),\n              // Price Summary\n              if (_calculateNights() > 0) ..[\n                Card(\n                  color: Colors.blue[50],\n                  child: Padding(\n                    padding: const EdgeInsets.all(16),\n                    child: Column(\n                      children: [\n                        Row(\n                          mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                          children: [\n                            Text('\$${hotel.pricePerNight.toStringAsFixed(0)} × ${_calculateNights()} nights × $_rooms room(s)'),\n                            Text('\$${_calculateTotal(hotel).toStringAsFixed(2)}'),\n                          ],\n                        ),\n                        const Divider(),\n                        Row(\n                          mainAxisAlignment: MainAxisAlignment.spaceBetween,\n                          children: [\n                            const Text(\n                              'Total',\n                              style: TextStyle(\n                                fontSize: 18,\n                                fontWeight: FontWeight.bold,\n                              ),\n                            ),\n                            Text(\n                              '\$${_calculateTotal(hotel).toStringAsFixed(2)}',\n                              style: const TextStyle(\n                                fontSize: 24,\n                                fontWeight: FontWeight.bold,\n                                color: Colors.blue,\n                              ),\n                            ),\n                          ],\n                        ),\n                      ],\n                    ),\n                  ),\n                ),\n              ],\n              const SizedBox(height: 24),\n              // Confirm Button\n              SizedBox(\n                width: double.infinity,\n                child: ElevatedButton(\n                  onPressed: () => _submitBooking(hotel),\n                  style: ElevatedButton.styleFrom(\n                    backgroundColor: Colors.blue,\n                    foregroundColor: Colors.white,\n                    padding: const EdgeInsets.symmetric(vertical: 16),\n                    shape: RoundedRectangleBorder(\n                      borderRadius: BorderRadius.circular(12),\n                    ),\n                  ),\n                  child: const Text(\n                    'Confirm Booking',\n                    style: TextStyle(\n                      fontSize: 16,\n                      fontWeight: FontWeight.bold,\n                    ),\n                  ),\n                ),\n              ),\n              const SizedBox(height: 16),\n            ],\n          ),\n        ),\n      ),\n    );\n  }\n}